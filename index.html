<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>std114514 的小站</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
        }
        
        header {
            text-align: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            width: 100%;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            background: linear-gradient(45deg, #ffcc00, #ff6b00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 40px;
            width: 100%;
        }
        
        .wheel-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            flex: 1;
            min-width: 300px;
            max-width: 500px;
        }
        
        .wheel-container {
            position: relative;
            width: 350px;
            height: 350px;
            margin: 20px 0;
        }
        
        .wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(
                #ff5252, #ff4081, #e040fb, #7c4dff,
                #536dfe, #448aff, #40c4ff, #18ffff,
                #64ffda, #69f0ae, #b2ff59, #eeff41,
                #ffff00, #ffd740, #ffab40, #ff6e40
            );
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.6);
            transition: transform 4s cubic-bezier(0.17, 0.67, 0.16, 0.99);
            border: 8px solid #ffcc00;
        }
        
        .wheel-number {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4rem;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.8);
            z-index: 10;
            background: rgba(0, 0, 0, 0.5);
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 4px solid white;
        }
        
        .wheel-pointer {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 50px;
            background-color: #ffcc00;
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            z-index: 20;
            box-shadow: 0 0 15px rgba(255, 204, 0, 0.8);
            filter: drop-shadow(0 0 5px rgba(255, 204, 0, 0.5));
        }
        
        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
        }
        
        .result-display {
            background: rgba(255, 255, 255, 0.15);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            font-size: 1.3rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .result-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #ffcc00;
            margin-top: 5px;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.5);
        }
        
        button {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            background: linear-gradient(45deg, #ff5252, #ff4081);
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(255, 82, 82, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        button:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(255, 82, 82, 0.6);
        }
        
        button:active {
            transform: translateY(2px);
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .leaderboard-section {
            flex: 1;
            min-width: 300px;
            max-width: 500px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .leaderboard-title {
            text-align: center;
            margin-bottom: 20px;
            font-size: 2rem;
            color: #ffcc00;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.3);
        }
        
        .score-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        input {
            padding: 15px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }
        
        input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 204, 0, 0.5);
        }
        
        .leaderboard-list {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .leaderboard-list::-webkit-scrollbar {
            width: 8px;
        }
        
        .leaderboard-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        .leaderboard-list::-webkit-scrollbar-thumb {
            background: #ffcc00;
            border-radius: 10px;
        }
        
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin-bottom: 12px;
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }
        
        .leaderboard-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
            border-left: 4px solid #ffcc00;
        }
        
        .rank {
            font-weight: bold;
            color: #ffcc00;
            width: 30px;
            font-size: 1.2rem;
        }
        
        .player-name {
            flex: 1;
            text-align: left;
            font-weight: 500;
        }
        
        .player-score {
            font-weight: bold;
            width: 80px;
            text-align: right;
            font-size: 1.2rem;
        }
        
        .top-score {
            background: rgba(255, 204, 0, 0.2);
            border: 1px solid rgba(255, 204, 0, 0.5);
            box-shadow: 0 0 10px rgba(255, 204, 0, 0.2);
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
                align-items: center;
            }
            
            .wheel-section, .leaderboard-section {
                width: 100%;
            }
            
            .wheel-container {
                width: 300px;
                height: 300px;
            }
        }
        
        .progress-container {
            width: 100%;
            height: 12px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #ff5252, #ffcc00);
            width: 0%;
            transition: width 0.3s;
            border-radius: 10px;
        }
        
        .info-message {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: 10px;
            margin-top: 10px;
            font-size: 0.9rem;
            text-align: center;
            transition: all 0.3s;
        }
        
        .warning {
            background: rgba(255, 204, 0, 0.2);
            color: #ffcc00;
            border: 1px solid rgba(255, 204, 0, 0.5);
        }
        
        .leaderboard-note {
            text-align: center;
            margin-top: 10px;
            font-size: 0.9rem;
            opacity: 0.8;
            background: rgba(0, 0, 0, 0.2);
            padding: 8px;
            border-radius: 8px;
        }
        
        .stats {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            font-size: 1.2rem;
        }
        
        .ip-display {
            font-size: 0.8rem;
            opacity: 0.7;
            text-align: center;
            margin-top: 5px;
        }
    </style>
    
    <!-- 引入 Supabase SDK 替代 Firebase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>RPTester v1.1.4</h1>
            <p class="subtitle">by std114514</p>
        </header>
        
        <div class="main-content">
            <section class="wheel-section">
                <div class="wheel-container">
                    <div class="wheel" id="wheel">
                        <div class="wheel-number" id="wheelNumber">0</div>
                    </div>
                    <div class="wheel-pointer"></div>
                </div>
                
                <div class="controls">
                    <div class="result-display">
                        你的RP: <span class="result-number" id="result">-</span>
                    </div>
                    <div class="info-message" id="dailyInfo">
                        正在获取IP地址...
                    </div>
                    <div class="ip-display" id="ipDisplay">
                        IP: 获取中...
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                    <button id="spinButton">开始抽奖</button>
                </div>
            </section>
            
            <section class="leaderboard-section">
                <h2 class="leaderboard-title">14天内的前10名</h2>
                
                <div class="score-form">
                    <input type="text" id="playerName" placeholder="请输入您的名字" maxlength="15">
                    <button id="submitScore">上传成绩到排行榜</button>
                </div>
                
                <div class="stats">
                    <div>今日已测RP: <span id="todaySpins">0</span> 次</div>
                    <div>总用户数: <span id="totalUsers">0</span></div>
                </div>
                
                <div class="leaderboard-list" id="leaderboard">
                    <div class="loading">加载排行榜中...</div>
                </div>
            </section>
        </div>
    </div>

    <script>
        // Supabase 配置 - 请替换为您的实际配置
        const SUPABASE_URL = 'https://xwrgpngwmdjbmsziuodl.supabase.co'; // 替换为您的 Supabase URL
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh3cmdwbmd3bWRqYm1zeml1b2RsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxNDUzNjksImV4cCI6MjA3NTcyMTM2OX0.kVpcSCmmwcLcs60C0BjPxyXFDxdl3V4ny-vutKsnbV8'; // 替换为您的 Supabase anon key

        // 初始化 Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        document.addEventListener('DOMContentLoaded', function() {
            // 获取DOM元素
            const wheel = document.getElementById('wheel');
            const wheelNumber = document.getElementById('wheelNumber');
            const resultDisplay = document.getElementById('result');
            const spinButton = document.getElementById('spinButton');
            const playerNameInput = document.getElementById('playerName');
            const submitScoreButton = document.getElementById('submitScore');
            const leaderboard = document.getElementById('leaderboard');
            const progressBar = document.getElementById('progressBar');
            const dailyInfo = document.getElementById('dailyInfo');
            const todaySpins = document.getElementById('todaySpins');
            const totalUsers = document.getElementById('totalUsers');
            const ipDisplay = document.getElementById('ipDisplay');
            
            let currentResult = null;
            let isSpinning = false;
            let canUploadToday = true;
            let todaySpinsCount = 0;
            let userIP = '';

            // 获取客户端IP
            async function getClientIP() {
                if (!userIP) {
                    try {
                        // 使用第三方服务获取IP
                        const response = await fetch('https://api.ipify.cn?format=json');
                        const data = await response.json();
                        userIP = data.ip;
                        ipDisplay.textContent = `IP: ${userIP}`;
                    } catch (error) {
                        console.error('获取IP失败:', error);
                        // 如果获取失败，使用备用方案
                        userIP = 'unknown-' + Math.random().toString(36).substr(2, 9);
                        ipDisplay.textContent = `IP: 获取失败 (使用临时标识)`;
                    }
                }
                return userIP;
            }

            // 检查今天是否已经上传过成绩
            async function checkDailyUpload() {
                try {
                    const today = new Date().toISOString().split('T')[0];
                    const ip = await getClientIP();
                    
                    // 使用 Supabase 查询今天是否已提交
                    const { data, error } = await supabase
                        .from('scores')
                        .select('*')
                        .eq('ip', ip)
                        .eq('date', today);
                    
                    if (error) throw error;
                    
                    if (data && data.length > 0) {
                        canUploadToday = false;
                        dailyInfo.textContent = "今天已经上传过成绩，无法再次上传";
                        dailyInfo.className = "info-message warning";
                        submitScoreButton.disabled = true;
                    } else {
                        canUploadToday = true;
                        dailyInfo.textContent = "今天还可以上传成绩";
                        dailyInfo.className = "info-message";
                        submitScoreButton.disabled = false;
                    }
                } catch (error) {
                    console.error('检查上传状态失败:', error);
                }
            }

            // 获取14天前的日期
            function getFourteenDaysAgo() {
                const date = new Date();
                date.setDate(date.getDate() - 14);
                return date;
            }

            // 渲染排行榜
            function renderLeaderboard(scores) {
                // 清空排行榜
                leaderboard.innerHTML = '';
                
                if (scores.length === 0) {
                    leaderboard.innerHTML = '<div class="info-message">暂无排行榜数据</div>';
                    return;
                }
                
                // 添加排行榜条目
                scores.forEach((entry, index) => {
                    const item = document.createElement('div');
                    item.className = `leaderboard-item ${index === 0 ? 'top-score' : ''}`;
                    
                    item.innerHTML = `
                        <div class="rank">${index + 1}</div>
                        <div class="player-name">${entry.name}</div>
                        <div class="player-score">${entry.score}</div>
                    `;
                    
                    leaderboard.appendChild(item);
                });
            }

            // 实时监听排行榜变化 - 使用 Supabase 实时订阅
            function setupLeaderboardListener() {
                const fourteenDaysAgo = getFourteenDaysAgo();
                const fourteenDaysAgoString = fourteenDaysAgo.toISOString().split('T')[0];
                
                // 设置实时订阅
                const subscription = supabase
                    .channel('leaderboard-changes')
                    .on(
                        'postgres_changes',
                        {
                            event: '*',
                            schema: 'public',
                            table: 'scores'
                        },
                        async (payload) => {
                            // 当数据变化时，重新获取排行榜
                            await fetchLeaderboard();
                        }
                    )
                    .subscribe();
                
                // 初始获取排行榜
                fetchLeaderboard();
            }

            // 获取排行榜数据
            async function fetchLeaderboard() {
                try {
                    const fourteenDaysAgo = getFourteenDaysAgo();
                    const fourteenDaysAgoString = fourteenDaysAgo.toISOString().split('T')[0];
                    
                    // 使用 Supabase 查询14天内的前10名
                    const { data, error } = await supabase
                        .from('scores')
                        .select('*')
                        .gte('date', fourteenDaysAgoString)
                        .order('score', { ascending: false })
                        .order('date', { ascending: false })
                        .limit(10);
                    
                    if (error) throw error;
                    
                    renderLeaderboard(data || []);
                } catch (error) {
                    console.error('获取排行榜失败:', error);
                    leaderboard.innerHTML = '<div class="info-message">加载排行榜失败</div>';
                }
            }

            // 获取统计数据
            async function fetchStats() {
                try {
                    // 获取总用户数（去重）
                    const { data: usersData, error: usersError } = await supabase
                        .from('scores')
                        .select('ip');
                    
                    if (usersError) throw usersError;
                    
                    const uniqueUsers = new Set();
                    usersData.forEach(entry => {
                        uniqueUsers.add(entry.ip);
                    });
                    totalUsers.textContent = uniqueUsers.size;
                    
                    // 获取今日抽奖次数
                    const today = new Date().toISOString().split('T')[0];
                    const ip = await getClientIP();
                    
                    const { data: spinsData, error: spinsError } = await supabase
                        .from('spins')
                        .select('*')
                        .eq('ip', ip)
                        .eq('date', today);
                    
                    if (spinsError) throw spinsError;
                    
                    todaySpinsCount = spinsData.length;
                    todaySpins.textContent = todaySpinsCount;
                } catch (error) {
                    console.error('获取统计数据失败:', error);
                }
            }

            // 初始化
            async function init() {
                // 先获取IP
                await getClientIP();
                
                // 检查上传状态
                await checkDailyUpload();
                
                // 设置排行榜监听
                setupLeaderboardListener();
                
                // 获取统计数据
                await fetchStats();
                
                // 重置转盘位置
                wheel.style.transition = 'none';
                wheel.style.transform = 'rotate(0deg)';
                wheelNumber.textContent = '0';
                
                // 强制重绘
                void wheel.offsetWidth;
                
                // 恢复过渡效果
                wheel.style.transition = 'transform 4s cubic-bezier(0.17, 0.67, 0.16, 0.99)';
            }

            init();

            // 抽奖功能
            spinButton.addEventListener('click', function() {
                if (isSpinning) return;
                
                isSpinning = true;
                spinButton.disabled = true;
                progressBar.style.width = '0%';
                
                // 生成随机数
                const randomNumber = Math.floor(Math.random() * 1000);
                
                // 计算旋转角度（确保停在随机数对应的位置）
                const rotations = 7; // 7圈
                const finalRotation = rotations * 360 + (360 - (randomNumber % 360));
                
                // 重置转盘位置并开始旋转
                wheel.style.transition = 'none';
                wheel.style.transform = 'rotate(0deg)';
                
                // 强制重绘
                void wheel.offsetWidth;
                
                // 恢复过渡效果并开始旋转
                wheel.style.transition = 'transform 4s cubic-bezier(0.17, 0.67, 0.16, 0.99)';
                wheel.style.transform = `rotate(${finalRotation}deg)`;
                
                // 定义数字更新间隔序列
                const intervals = [
                    ...Array(15).fill(100),   // 0.1秒 * 15
                    ...Array(7).fill(150),    // 0.15秒 * 7
                    ...Array(4).fill(200),    // 0.2秒 * 4
                    ...Array(2).fill(300),    // 0.3秒 * 2
                    ...Array(1).fill(500),    // 0.5秒 * 1
                    ...Array(1).fill(1000)    // 1秒 * 1
                ];
                
                let currentIntervalIndex = 0;
                let updateCount = 0;
                const totalUpdates = intervals.length;
                
                // 更新进度条
                function updateProgress() {
                    const progress = (updateCount / totalUpdates) * 100;
                    progressBar.style.width = `${progress}%`;
                }
                
                // 数字更新函数
                function updateNumber() {
                    if (currentIntervalIndex < intervals.length) {
                        // 显示随机数
                        wheelNumber.textContent = Math.floor(Math.random() * 1000);
                        
                        // 设置下一个更新时间
                        setTimeout(updateNumber, intervals[currentIntervalIndex]);
                        
                        currentIntervalIndex++;
                        updateCount++;
                        updateProgress();
                    } else {
                        // 更新完成，显示最终结果
                        wheelNumber.textContent = randomNumber;
                        resultDisplay.textContent = randomNumber;
                        currentResult = randomNumber;
                        isSpinning = false;
                        spinButton.disabled = false;
                        progressBar.style.width = '100%';
                        
                        // 记录抽奖次数
                        recordSpin();
                    }
                }
                
                // 开始数字更新序列
                updateNumber();
            });

            // 记录抽奖次数
            async function recordSpin() {
                try {
                    const today = new Date().toISOString().split('T')[0];
                    const ip = await getClientIP();
                    
                    // 使用 Supabase 插入数据
                    const { error } = await supabase
                        .from('spins')
                        .insert([
                            {
                                ip: ip,
                                date: today
                            }
                        ]);
                    
                    if (error) throw error;
                    
                    todaySpinsCount++;
                    todaySpins.textContent = todaySpinsCount;
                } catch (error) {
                    console.error('记录抽奖次数失败:', error);
                }
            }
            
            // 提交成绩到排行榜
            submitScoreButton.addEventListener('click', async function() {
                if (!currentResult) {
                    alert('请先进行抽奖！');
                    return;
                }
                
                if (!canUploadToday) {
                    alert('今天已经上传过成绩，无法再次上传！');
                    return;
                }
                
                const playerName = playerNameInput.value.trim();
                if (!playerName) {
                    alert('请输入名字！');
                    return;
                }
                
                try {
                    const today = new Date().toISOString().split('T')[0];
                    const ip = await getClientIP();
                    
                    // 使用 Supabase 插入数据
                    const { error } = await supabase
                        .from('scores')
                        .insert([
                            {
                                name: playerName,
                                score: currentResult,
                                ip: ip,
                                date: today
                            }
                        ]);
                    
                    if (error) throw error;
                    
                    // 更新状态
                    canUploadToday = false;
                    dailyInfo.textContent = "今天已经上传过成绩，无法再次上传";
                    dailyInfo.className = "info-message warning";
                    submitScoreButton.disabled = true;
                    
                    // 清空输入框
                    playerNameInput.value = '';
                    
                    alert('成绩上传成功！');
                } catch (error) {
                    console.error('提交成绩失败:', error);
                    alert('上传失败，请稍后重试');
                }
            });
        });
    </script>
</body>
</html>
